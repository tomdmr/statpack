<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link href="css/pms.css" rel="stylesheet" type="text/css" />
        <script src="js/jquery-3.5.1.min.js"></script>
        <script src="js/jquery.dataTables.min.js"></script>
        <script src="js/plotly-2.1.0.min.js"></script>
        <script src="js/fast-stats.js"></script>
        <title>Template Title</title>
    </head>
    <body>
        <div id='myDiv' style="height: 20cm"></div>
    </body>
    <script>
     /*
      *
      * Compute basic statistics for an I-MR chart:
      * MR     : Moving range
      * MRMean : Mean of ranges
      */
     /*
        // https://www.isixsigma.com/topic/d2-d3-d4-c4-a2-novice-question-2/
      */
     function XMR(data){
         // https://r-bar.net/control-chart-constants-tables-explanations/
         let d2 = [1.1284, 1.6926, 2.0588, 2.3259, 2.5344, 2.7044, 2.8472, 2.9700,
                   3.0775, 3.1729, 3.2585, 3.3360, 3.4068, 3.4718, 3.5320, 3.5879,
                   3.6401, 3.6890, 3.7349, 3.7783, 3.8194, 3.8583, 3.8953, 3.9306,
                   3.9643, 3.9965, 4.0274, 4.0570, 4.0855];
         let A2 = [1.8800, 1.0233, 0.7286, 0.5768, 0.4832, 0.4193, 0.3725, 0.3367,
                   0.3083, 0.2851, 0.2658, 0.2494, 0.2354, 0.2231, 0.2123, 0.2028,
                   0.1943, 0.1866, 0.1796, 0.1733, 0.1675, 0.1621, 0.1572, 0.1526,
                   0.1484, 0.1445, 0.1408, 0.1373, 0.1341];     
         let D3 = [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0757, 0.1362, 0.1840,
                   0.2230, 0.2556, 0.2833, 0.3072, 0.3281, 0.3466, 0.3630, 0.3779,
                   0.3913, 0.4035, 0.4147, 0.4250, 0.4345, 0.4434, 0.4516, 0.4593,
                   0.4665, 0.4733, 0.4797, 0.4857, 0.4914];
         let D4 = [3.2665, 2.5746, 2.2821, 2.1145, 2.0038, 1.9243, 1.8638, 1.8160,
                   1.7770, 1.7444, 1.7167, 1.6928, 1.6719, 1.6534, 1.6370, 1.6221,
                   1.6087, 1.5965, 1.5853, 1.5750, 1.5655, 1.5566, 1.5484, 1.5407,
                   1.5335, 1.5267, 1.5203, 1.5143, 1.5086];
         let XBar = 0;
         let RBar = 0;
         let XiBar = [];
         let Ri    = [];
         let Mini  = [];
         let Maxi  = [];
         let M = data[0].length-1;
         let N = data.length;
         for(i=0; i<data.length; i++){
             let xmin =  1e9;
             let xmax = -1e9;
             let XjBar= 0.0;
             for(j=1; j<data[i].length; j++){
                 if( data[i][j] > xmax) xmax = data[i][j];
                 if( data[i][j] < xmin) xmin = data[i][j];
                 XBar  += data[i][j];
                 XjBar += data[i][j];
             }
             RBar += xmax - xmin;
             Ri[i] = xmax - xmin;
             XiBar[i] = XjBar / M;
             Mini[i] = XiBar[i]-xmin;
             Maxi[i] = xmax-XiBar[i];
         }
         XBar /= (M*N);
         RBar /= N;
         let UCL = XBar + A2[M-2]*RBar;
         let LCL = XBar - A2[M-2]*RBar;
         let UCLR =  D4[M-2]*RBar;
         let LCLR =  D3[M-2]*RBar;
         return {
             'XBar': XBar, 'RBar': RBar, 'UCL': UCL, 'LCL': LCL, 'UCLR': UCLR, 'LCLR': LCLR, 'XiBar': XiBar, 'Ri': Ri,
             'Mini' : Mini, 'Maxi': Maxi,
         };
     }

     function XMR_Chart(data, divName){
         let XMR_Result = XMR(data);
         let dataIdx  = Array.from({length: data.length}, (_, i) => i + 1);
         let XViol = {x: [], y:[]};
         
         for (i=0; i< data.length; i++){
             if( (XMR_Result.XiBar[i]>XMR_Result.UCL) || (XMR_Result.XiBar[i]<XMR_Result.LCL)){
                 XViol.x.push(i+1);
                 XViol.y.push(XMR_Result.XiBar[i]);
             }
         }

         // Data plot
         var Data = {
             type: 'scatter',
             x: dataIdx,
             y: XMR_Result.XiBar,
             mode: 'lines+markers',
             name: 'Data',
             showlegend: true,
             hoverinfo: 'all',
             line: {
                 color: 'blue',
                 width: 2
             },
             marker: {
                 color: 'blue',
                 size: 8,
                 symbol: 'circle'
             },
             error_y: { type: 'data', symmetric: false, array: XMR_Result.Maxi, arrayminus: XMR_Result.Mini }
         }
         // Violations
         var Viol = {
             type: 'scatter',
             x: XViol.x,
             y: XViol.y,
             mode: 'markers',
             name: 'Violation',
             showlegend: true,
             marker: {
                 color: 'rgb(255,65,54)',
                 line: {width: 3},
                 opacity: 0.5,
                 size: 12,
                 symbol: 'circle-open'
             }
         }
         // Control Limits
         var CL = {
             type: 'scatter',
             x: [0.5, data.length, null, 0.5, data.length],
             //y: [-5, -5, null, 5, 5],
             y: [XMR_Result.LCL, XMR_Result.LCL, null, XMR_Result.UCL, XMR_Result.UCL],
             mode: 'lines',
             name: 'LCL/UCL',
             showlegend: true,
             line: {
                 color: 'red',
                 width: 2,
                 dash: 'dash'
             }
         }
         // Centerline
         var Centre = {
             type: 'scatter',
             x: [0.5, data.length],
             y: [XMR_Result.XBar,XMR_Result.XBar],
             //[ 0, 0],
             mode: 'lines',
             name: 'Centre',
             showlegend: true,
             line: {
                 color: 'grey',
                 width: 2
             }
         }
         var MRMR = {
             type: 'scatter',
             x: dataIdx,
             y: XMR_Result.Ri,
             name: 'Ri',
             mode: 'lines+markers',
             line: {
                 color: 'blue',
                 width: 2
             },
             marker: {
                 color: 'blue',
                 size: 8,
                 symbol: 'circle'
             },
             xaxis: 'x1',
             yaxis: 'y2',
         }

         var MRCL = {
             type: 'scatter',
             x: [0.5, data.length,null, 0.5, data.length ],
             y: [XMR_Result.UCLR, XMR_Result.UCLR, null, XMR_Result.LCLR, XMR_Result.LCLR],
             mode: 'lines',
             name: 'R-UCL',
             showlegend: true,
             line: {
                 color: 'red',
                 width: 2,
                 dash: 'dash'
             },
             xaxis: 'x1',
             yaxis: 'y2',
         }
         var plData = [Data,Viol, CL,Centre, MRMR, MRCL]
         var layout = {
             title: 'SPC Run-Chart, XBar-R',
             grid: {rows: 2, columns: 1,},
             xaxis: {
                 zeroline: false
             },
             yaxis: {
                 //range: [-20,20],
                 zeroline: false
             },
         }
         Plotly.newPlot(divName, plData,layout);

     }
     let sampleData = [
         ["30.10.2020", 64.0, 63.6, 64.3, 63.3, 63.0, 63.4],
         ["30.10.2020", 63.9, 62.9, 63.9, 63.6, 64.1, 63.8],
         ["09.11.2020", 61.2, 63.3, 63.4, 63.6, 63.8, 64.6],
         ["15.11.2020", 62.2, 63.1, 62.8, 63.7, 64.7, 64.4],
         ["17.11.2020", 63.6, 65.6, 64.5, 64.8, 64.3, 63.7],
         ["19.11.2020", 63.9, 64.1, 64.7, 63.9, 64.6, 64.0],
         ["22.11.2020", 62.9, 63.4, 63.1, 63.0, 63.5, 63.8],
         ["22.11.2020", 63.8, 65.5, 63.8, 62.9, 63.2, 64.1],
         ["24.11.2020", 64.5, 63.3, 64.1, 63.6, 64.3, 63.7],
         ["29.11.2020", 62.5, 63.1, 63.3, 63.5, 63.7, 63.0],
         ["30.11.2020", 62.3, 61.6, 61.1, 60.6, 61.1, 60.3],
         ["03.12.2020", 62.4, 63.9, 64.2, 64.1, 64.4, 63.9],
         ["06.12.2020", 62.0, 63.2, 63.1, 63.2, 63.2, 63.3],
         ["11.12.2020", 62.2, 63.4, 63.1, 63.2, 63.8, 64.1],
         ["13.12.2020", 62.7, 62.5, 63.0, 63.1, 63.4, 61.7],
         ["17.12.2020", 63.3, 64.3, 64.1, 63.5, 63.5, 63.6],
         ["20.12.2020", 61.8, 62.8, 63.0, 63.5, 63.4, 64.4],
         ["27.12.2020", 62.9, 64.2, 63.1, 63.4, 63.5, 63.3],
         ["27.12.2020", 64.1, 64.6, 64.8, 64.6, 63.5, 64.9],
         ["28.12.2020", 63.4, 64.5, 64.8, 64.6, 63.0, 64.0],
         ["04.01.2021", 60.9, 63.0, 62.5, 63.5, 63.4, 63.7],
         ["09.01.2021", 62.4, 63.4, 64.4, 63.7, 64.1, 63.8],
         ["14.01.2021", 61.2, 62.9, 64.1, 63.5, 63.0, 63.4],
     ];
     XMR_Chart(sampleData, 'myDiv');
    </script>
</html>
