<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link href="css/pms.css" rel="stylesheet" type="text/css" />
        <script src="js/jquery-3.5.1.min.js"></script>
        <script src="js/jquery.dataTables.min.js"></script>
        <script src="js/plotly-2.1.0.min.js"></script>
        <script src="js/fast-stats.js"></script>
        <title>Template Title</title>
    </head>
    <body>
        <div id='myDiv' style="height: 20cm"></div>
    </body>
    <script>
     /*
      *
      * Compute basic statistics for an I-MR chart:
      * MR     : Moving range
      * MRMean : Mean of ranges
      */
     function IMR(data){
         let MR = [];
         let MRBar = 0;
         let IBar  = data[0];
         //console.log(data.length);
         for(i=1; i<data.length; i++){
             dx = Math.abs(data[i]-data[i-1]);
             MR.push(dx);
             MRBar += dx;
             IBar  += data[i];
         }
         //console.log(MR);
         IBar   /= data.length;
         MRBar  /= (data.length-1);

         LCL_MR = 0.0;
         UCL_MR = 3.267 * MRBar;
         LCL_I  = IBar - 2.66*MRBar;
         UCL_I  = IBar + 2.66*MRBar;
         return {'MR': MR, 'LCL_MR': LCL_MR, 'UCL_MR': UCL_MR, 'LCL_I': LCL_I, 'IBar': IBar, 'UCL_I': UCL_I};
     }

     function IMR_Chart(data, divName){
         let dataIdx  = Array.from({length: data.length}, (_, i) => i + 1);
         let mrIdx    = dataIdx.slice(1);
         let IMR_Result = IMR(data);
         let stats = new Stats().push(data);
         let IViol = {x: [], y:[]};
         for (i=0; i< data.length; i++){
             if( (sampleData[i]>IMR_Result.UCL_I) || (sampleData[i]<IMR_Result.LCL_I)){
                 IViol.x.push(i+1);
                 IViol.y.push(sampleData[i]);
             }
         }         
         // Data plot
         var Data = {
             type: 'scatter',
             x: dataIdx,
             y: data,
             mode: 'lines+markers',
             name: 'Data',
             showlegend: true,
             hoverinfo: 'all',
             line: {
                 color: 'blue',
                 width: 2
             },
             marker: {
                 color: 'blue',
                 size: 8,
                 symbol: 'circle'
             }
         }
         // Violations
         var Viol = {
             type: 'scatter',
             x: IViol.x,
             y: IViol.y,
             mode: 'markers',
             name: 'Violation',
             showlegend: true,
             marker: {
                 color: 'rgb(255,65,54)',
                 line: {width: 3},
                 opacity: 0.5,
                 size: 12,
                 symbol: 'circle-open'
             }
         }
         // Control Limits
         var CL = {
             type: 'scatter',
             x: [0.5, data.length, null, 0.5, data.length],
             //y: [-5, -5, null, 5, 5],
             y: [IMR_Result.LCL_I, IMR_Result.LCL_I, null, IMR_Result.UCL_I, IMR_Result.UCL_I],
             mode: 'lines',
             name: 'LCL/UCL',
             showlegend: true,
             line: {
                 color: 'red',
                 width: 2,
                 dash: 'dash'
             }
         }
         // Centerline
         var Centre = {
             type: 'scatter',
             x: [0.5, data.length],
             y: [IMR_Result.IBar,IMR_Result.IBar],
             //[ 0, 0],
             mode: 'lines',
             name: 'Centre',
             showlegend: true,
             line: {
                 color: 'grey',
                 width: 2
             }
         }
         var MRMR = {
             type: 'scatter',
             x: mrIdx,
             y: IMR_Result.MR,
             name: 'MR',
             mode: 'lines+markers',
             line: {
                 color: 'blue',
                 width: 2
             },
             marker: {
                 color: 'blue',
                 size: 8,
                 symbol: 'circle'
             },
             xaxis: 'x1',
             yaxis: 'y2',
         }
         var MRCL = {
             type: 'scatter',
             x: [0.5, data.length, ],
             y: [IMR_Result.UCL_MR, IMR_Result.UCL_MR],
             mode: 'lines',
             name: 'MR-UCL',
             showlegend: true,
             line: {
                 color: 'red',
                 width: 2,
                 dash: 'dash'
             },
             xaxis: 'x1',
             yaxis: 'y2',         
         }
         var plData = [Data,Viol,CL,Centre, MRMR, MRCL]
         var layout = {
             title: 'SPC Run-Chart, IBar-MR',
             grid: {rows: 2, columns: 1,},
             xaxis: {
                 zeroline: false
             },
             yaxis: {
                 //range: [-20,20],
                 zeroline: false
             },
         }
         Plotly.newPlot(divName, plData,layout);
     }
     //let sampleData = //[4,2,-1,4,-5,-7,0,3,8];
     let sampleData = [
         154.61,146.205,148.585,140.23,137.535,132.57,141.045,139.91,152.86,152.43,137.6,149.15,146.475,153.205,147.07,144.35,159.47,
         152.64,154.875,150.15,150.07,154.345,157.555,145.775,150.17,155.275,180.84,165.71,165.585,161.86,165.93,154.4,154.035,158.56,
         159.275,152.165,159.535,155,148.995,167.71];

     IMR_Chart(sampleData, 'myDiv');
    </script>
</html>
