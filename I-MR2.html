<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link href="css/pms.css" rel="stylesheet" type="text/css" />
        <!-- script src="js/jquery-3.5.1.min.js"></script  -->
        <!-- script src="js/jquery.dataTables.min.js"></script -->
        <script src="js/readers.js"></script>
        <script src="js/sprintf.min.js"></script>
        <script src="js/d3.v7.min.js"></script>
        <script src="js/plotly-2.1.0.min.js"></script>
        <script src="js/fast-stats.js"></script>
        <style>
         .resizable {
             resize: both;
             overflow: scroll;
             border: 1px solid black;
             width: 600px;
             height: 300px;
         }
        </style>
        <title>I-MR Chart (Regelkarte)</title>
    </head>
    <body>
        <h2>Regelkarte für I-MR</h2>
        Regelkarte zur Darstellung von Produktionsverläufen. Das
        I-MR-Chart wird benutzt, wenn pro Charge nur ein
        charakteristischer Messwert zur Verfügung steht.
        <p>In das Datenfeld zeilenweise Zahlen
            eingeben, bei Bedarf noch oberen und unteren
            Spezifikationswert eingeben.
            <p>
                <table>
                    <tr>
                        <td>Titel</td><td><input type="text" id="title" value="" /></td></td>
                    </tr>
                    <tr>
                        <td>USL:</td><td><input type="number" id="iusl" /></td>
                    </tr>
                    <tr>
                        <td>LSL:</td><td><input type="number" id="ilsl" /></td>
                    </tr>
                    <tr>
                        <td>Daten</td>
                        <td>
                            <textarea id="tdata">
                            </textarea>
                        </td>
                    </tr>
                    <tr>
                        <td><button onclick="makeDiag()">Make</button></td>
                        <td><button onclick="makeImg('myDiv', 'jpg-export')">Copy</button></td>
                    </tr>
                    <tr>
                        <td>Width</td><td><input type="number" id="cWidth" value="600" onchange="cHWChange()" /></td>
                    </tr>
                    <tr>
                        <td>Height</td><td><input type="number" id="cHeight" value="300" onchange="cHWChange()"" /></td>
                    </tr>
                </table>
                <p>
                    <div id='myDiv' class="resizable" onresize="doResize()"></div>
                    <br>
                </p>
                <img id="jpg-export"></img>
    </body>
    <script>
     function IMR(data){
         let MR = [];
         let MRBar = 0;
         let IBar  = data[0];
         //console.log(data.length);
         for(i=1; i<data.length; i++){
             dx = Math.abs(data[i]-data[i-1]);
             MR.push(dx);
             MRBar += dx;
             IBar  += data[i];
         }
         //console.log(MR);
         IBar   /= data.length;
         MRBar  /= (data.length-1);

         LCL_MR = 0.0;
         UCL_MR = 3.267 * MRBar;
         LCL_I  = IBar - 2.66*MRBar;
         UCL_I  = IBar + 2.66*MRBar;
         return {'MR': MR, 'LCL_MR': LCL_MR, 'UCL_MR': UCL_MR, 'LCL_I': LCL_I, 'IBar': IBar, 'UCL_I': UCL_I};
     }

     function IMR_Chart(divName, data, title, usl, lsl){
         let dataIdx  = Array.from({length: data.length}, (_, i) => i + 1);
         let mrIdx    = dataIdx.slice(1);
         let IMR_Result = IMR(data);
         let stats = new Stats().push(data);
         let IViol = {x: [], y:[]};
         for (i=0; i< data.length; i++){
             if( (data[i]>IMR_Result.UCL_I) || (data[i]<IMR_Result.LCL_I)){
                 IViol.x.push(i+1);
                 IViol.y.push(data[i]);
             }
         }
         // Data plot
         var Data = {
             type: 'scatter',
             x: dataIdx,
             y: data,
             mode: 'lines+markers',
             name: 'Data',
             showlegend: true,
             hoverinfo: 'all',
             line: {
                 color: 'blue',
                 width: 2
             },
             marker: {
                 color: 'blue',
                 size: 8,
                 symbol: 'circle'
             }
         }
         // Violations
         var Viol = {
             type: 'scatter',
             x: IViol.x,
             y: IViol.y,
             mode: 'markers',
             name: 'Violation',
             showlegend: true,
             marker: {
                 color: 'rgb(255,65,54)',
                 line: {width: 3},
                 opacity: 0.5,
                 size: 12,
                 symbol: 'circle-open'
             }
         }
         // Control Limits
         var CL = {
             type: 'scatter',
             x: [0.5, data.length, null, 0.5, data.length],
             //y: [-5, -5, null, 5, 5],
             y: [IMR_Result.LCL_I, IMR_Result.LCL_I, null, IMR_Result.UCL_I, IMR_Result.UCL_I],
             mode: 'lines',
             name: 'LCL/UCL',
             showlegend: true,
             line: {
                 color: 'red',
                 width: 2,
                 dash: 'dash'
             }
         }
         // Centerline
         var Centre = {
             type: 'scatter',
             x: [0.5, data.length],
             y: [IMR_Result.IBar,IMR_Result.IBar],
             //[ 0, 0],
             mode: 'lines',
             name: 'Centre ' + sprintf("%.2f", IMR_Result.IBar),
             showlegend: true,
             line: {
                 color: 'grey',
                 width: 2
             }
         }
         var MRMR = {
             type: 'scatter',
             x: mrIdx,
             y: IMR_Result.MR,
             name: 'MR',
             mode: 'lines+markers',
             line: {
                 color: 'blue',
                 width: 2
             },
             marker: {
                 color: 'blue',
                 size: 8,
                 symbol: 'circle'
             },
             xaxis: 'x1',
             yaxis: 'y2',
         }
         var MRCL = {
             type: 'scatter',
             x: [0.5, data.length, ],
             y: [IMR_Result.UCL_MR, IMR_Result.UCL_MR],
             mode: 'lines',
             name: 'MR-UCL',
             showlegend: true,
             line: {
                 color: 'red',
                 width: 2,
                 dash: 'dash'
             },
             xaxis: 'x1',
             yaxis: 'y2',
         }
         var plData = [Data,Viol,CL,Centre, MRMR, MRCL]
         if( SL.length ){
             plData.push({
                 type: 'scatter',
                 x: [0.5, data.length, null, 0.5, data.length],
                 y: [SL[0], SL[0], null, SL[1], SL[1]],
                 mode: 'lines',
                 name: 'LSL/USL',
                 showlegend: true,
                 line: {
                     color: 'red',
                     width: 2,
                     //dash: 'dash'
                 }
             }
             );
         }
         if (typeof(title) == "undefined"){
             console.log('No Title');
             myTitle = 'SPC Run-Chart, IBar-MR'
         }else{
             myTitle = title;
         }
         var layout = {
             title: myTitle,
             grid: {rows: 2, columns: 1,},
             xaxis: {
                 zeroline: false
             },
             yaxis: {
                 //range: [-20,20],
                 zeroline: false
             },
         }
         var img_jpg= d3.select('#jpg-export');
         let clientHeight = document.getElementById(divName).clientHeight;
         let clientWidth  = document.getElementById(divName).clientWidth;
         Plotly.newPlot(divName, plData,layout,  {editable: true, responsive: true},);
     }

     // @params blob - The ClipboardItem takes an object with the MIME type as key, and the actual blob as the value.
     // @return Promise<void>
     const setToClipboard = async blob => {
         const data = [new ClipboardItem({ [blob.type]: blob })]
         await navigator.clipboard.write(data)
     }


     function makeDiag(){
         let sampleData = [];
         let title = document.getElementById('title').value;
         let tdata = document.getElementById('tdata').value.split('\n');
         let LSL   = document.getElementById('ilsl').value;
         let USL   = document.getElementById('iusl').value;
         console.log(tdata);
         if((USL ==='') || (LSL==='')){
             console.log('No usl');
             SL = []
         }
         else{
             SL = [Number(USL), Number(LSL)];
         }
         console.log(title);
         //console.log(tdata);
         tdata.forEach(function(line){
             line=line.trim().replace(',', '.');
             if( line !== ''){
                 sampleData.push(Number(line));
                 //console.log(Number(line));
             }
         });
         IMR_Chart('myDiv', sampleData, title, SL);
     }
     function cHWChange(){
         let W = document.getElementById('cWidth').value;
         let H = document.getElementById('cHeight').value;
         document.getElementById('myDiv').setAttribute("style","Width:"+ W +'px;Height:'+ H+'px');
     }
     
     function syntheticResize(){
         var evt = window.document.createEvent('UIEvents');
         evt.initUIEvent('resize', true, false, 0);
         window.dispatchEvent(evt);
     }
    </script>
</html>
